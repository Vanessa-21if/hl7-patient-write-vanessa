<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Salud - Registro Medicamentos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #0f0bf3;
            text-align: center;
        }
        .form-section {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #f50ece;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #39f30b;
            color: hwb(322 2% 91%);
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
        }
        button:hover {
            background-color: #c451fafa;
        }
        #medicationSection {
            display: none;
            margin-top: 30px;
        }
        .required:after {
            content: " *";
            color: red;
        }
    </style>
</head>
<body>
    <h1>Sistema de Salud - Registro FHIR</h1>
    
    <div class="form-section">
        <h2>Datos del Paciente</h2>
        <form id="patientForm">
            <label for="name" class="required">Nombre:</label>
            <input type="text" id="name" name="name" required>

            <label for="familyName" class="required">Apellido:</label>
            <input type="text" id="familyName" name="familyName" required>

            <label for="gender" class="required">Género:</label>
            <select id="gender" name="gender" required>
                <option value="">Seleccione...</option>
                <option value="male">Masculino</option>
                <option value="female">Femenino</option>
                <option value="other">Otro</option>
                <option value="unknown">Desconocido</option>
            </select>

            <label for="birthDate" class="required">Fecha de Nacimiento:</label>
            <input type="date" id="birthDate" name="birthDate" required>

            <label for="identifierSystem" class="required">Tipo de documento:</label>
            <select id="identifierSystem" name="identifierSystem" required>
                <option value="">Seleccione...</option>
                <option value="http://cedula">Cédula de ciudadanía</option>
                <option value="http://pasaporte">Pasaporte</option>
                <option value="http://tarjeta-identidad">Tarjeta de identidad</option>
            </select>

            <label for="identifierValue" class="required">Número de documento:</label>
            <input type="text" id="identifierValue" name="identifierValue" required>

            <label for="cellPhone" class="required">Teléfono celular:</label>
            <input type="tel" id="cellPhone" name="cellPhone" required>

            <label for="email">Correo electrónico:</label>
            <input type="email" id="email" name="email">

            <label for="address" class="required">Dirección:</label>
            <input type="text" id="address" name="address" required>

            <label for="city" class="required">Ciudad:</label>
            <input type="text" id="city" name="city" required>

            <label for="postalCode">Código postal:</label>
            <input type="text" id="postalCode" name="postalCode">

            <button type="submit">Registrar Paciente</button>
        </form>
    </div>

    <div id="medicationSection" class="form-section">
        <h2>Registro de Medicamento</h2>
        <form id="medicationForm">
            <input type="hidden" id="patientId">
            
            <label for="medicationName" class="required">Nombre del medicamento:</label>
            <input type="text" id="medicationName" name="medicationName" required>

            <label for="quantity" class="required">Cantidad:</label>
            <input type="number" id="quantity" name="quantity" min="1" required>

            <label for="daysSupply" class="required">Días de tratamiento:</label>
            <input type="number" id="daysSupply" name="daysSupply" min="1" required>

            <label for="dosage" class="required">Instrucciones de dosificación:</label>
            <textarea id="dosage" name="dosage" rows="3" required></textarea>

            <label for="prescribedBy" class="required">Prescrito por:</label>
            <input type="text" id="prescribedBy" name="prescribedBy" required>

            <label for="notes">Notas adicionales:</label>
            <textarea id="notes" name="notes" rows="2"></textarea>

            <button type="submit">Registrar Medicamento</button>
        </form>
    </div>

    <script>
        document.getElementById('patientForm').addEventListener('submit', function(event) {
            event.preventDefault();

            // Obtener los valores del formulario
            const patientData = {
                name: document.getElementById('name').value,
                familyName: document.getElementById('familyName').value,
                gender: document.getElementById('gender').value,
                birthDate: document.getElementById('birthDate').value,
                identifierSystem: document.getElementById('identifierSystem').value,
                identifierValue: document.getElementById('identifierValue').value,
                cellPhone: document.getElementById('cellPhone').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                postalCode: document.getElementById('postalCode').value
            };

            // Crear el objeto Patient en formato FHIR
            const patient = {
                resourceType: "Patient",
                name: [{
                    use: "official",
                    given: [patientData.name],
                    family: patientData.familyName
                }],
                gender: patientData.gender,
                birthDate: patientData.birthDate,
                identifier: [{
                    system: patientData.identifierSystem,
                    value: patientData.identifierValue
                }],
                telecom: [
                    {
                        system: "phone",
                        value: patientData.cellPhone,
                        use: "home"
                    }
                ],
                address: [{
                    use: "home",
                    line: [patientData.address],
                    city: patientData.city,
                    postalCode: patientData.postalCode,
                    country: "Colombia"
                }]
            };

            // Añadir email si fue proporcionado
            if(patientData.email) {
                patient.telecom.push({
                    system: "email",
                    value: patientData.email,
                    use: "home"
                });
            }

            // Enviar los datos del paciente
            fetch('https://hl7-fhir-ehr-vane.onrender.com/patient', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(patient)
            })
            .then(response => response.json())
            .then(data => {
                if(data._id) {
                    alert('Paciente registrado exitosamente!');
                    document.getElementById('patientId').value = data._id;
                    document.getElementById('medicationSection').style.display = 'block';
                    window.scrollTo({
                        top: document.getElementById('medicationSection').offsetTop,
                        behavior: 'smooth'
                    });
                } else {
                    throw new Error('No se recibió ID de paciente');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al registrar el paciente: ' + error.message);
            });
        });

        document.getElementById('medicationForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const patientId = document.getElementById('patientId').value;
            const medicationData = {
                medication: document.getElementById('medicationName').value,
                quantity: document.getElementById('quantity').value,
                daysSupply: document.getElementById('daysSupply').value,
                dosage: document.getElementById('dosage').value,
                performer: document.getElementById('prescribedBy').value,
                notes: document.getElementById('notes').value
            };

            // Validación básica
            if(!patientId) {
                alert('No se ha identificado al paciente');
                return;
            }

            // Enviar datos del medicamento
            fetch(`https://hl7-fhir-ehr-vane.onrender.com/patient/${patientId}/medications`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(medicationData)
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success') {
                    alert('Medicamento registrado en la historia clínica!');
                    document.getElementById('medicationForm').reset();
                } else {
                    throw new Error(data.message || 'Error al registrar medicamento');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });
        });
        <script>
            
// Código mejorado para registro de medicamentos
document.getElementById('medicationForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    
    try {
        const patientId = document.getElementById('patientId').value;
        if (!patientId || !patientId.trim()) {
            throw new Error('No se ha identificado correctamente al paciente');
        }

        // Validación de campos numéricos
        const quantity = parseInt(document.getElementById('quantity').value);
        const daysSupply = parseInt(document.getElementById('daysSupply').value);
        
        if (isNaN(quantity) throw new Error('Cantidad debe ser un número');
        if (isNaN(daysSupply)) throw new Error('Días de tratamiento debe ser un número');

        // Estructura FHIR completa
        const medicationData = {
            resourceType: "MedicationDispense",
            status: "completed",
            medicationCodeableConcept: {
                text: document.getElementById('medicationName').value
            },
            subject: {
                reference: `Patient/${patientId}`
            },
            quantity: {
                value: quantity,
                unit: "unidades"
            },
            daysSupply: {
                value: daysSupply,
                unit: "días"
            },
            whenHandedOver: new Date().toISOString(),
            dosageInstruction: [{
                text: document.getElementById('dosage').value
            }],
            performer: [{
                actor: {
                    display: document.getElementById('prescribedBy').value
                }
            }]
        };

        // Agregar notas si existen
        const notes = document.getElementById('notes').value;
        if (notes) {
            medicationData.note = [{ text: notes }];
        }

        console.log("Datos a enviar:", medicationData); // Para depuración

        const response = await fetch(`https://hl7-fhir-ehr-vane.onrender.com/patient/${patientId}/medications`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(medicationData)
        });

        const data = await response.json();
        
        if (!response.ok) {
            console.error("Error del servidor:", data);
            throw new Error(data.message || `Error ${response.status}`);
        }

        alert("Medicamento registrado exitosamente!");
        document.getElementById('medicationForm').reset();
        
    } catch (error) {
        console.error("Error completo:", error);
        alert(`Error al registrar: ${error.message}`);
    }
});
</script>
    </script>
</body>
</html>
